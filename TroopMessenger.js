const constants=require("./constants");let Emitter=require("events").EventEmitter;const axios=require("axios");let $this,moment=require("moment");axios.defaults.baseURL="https://apis.troopmessenger.com",axios.defaults.headers.post["Content-Type"]="application/json",axios.defaults.headers.put["Content-Type"]="application/json";class TroopMessenger{constructor(e){if(this.token=e,this.user_id="",this.authorization_token="",this.socket=require("socket.io-client"),this.socket_id=null,this.access_token="",this.connection_state="pending",this.uid="",null===this.token||""===this.token||void 0===this.token)throw Error("Invalid Token!");$this=this}async login(e,t){return await register(e,t,this.token).then(function(t){return $this.uid=e,t}).catch(function(e){return{success:!1,message:"Something went wrong. Please try again after time."}})}async register(e,t){return await register(e,t,this.token,1).then(function(e){return e}).catch(function(e){return{success:!1,message:"Something went wrong. Please try again after time."}})}connect(e,t){let s=new Emitter,i=this;return this.user_id=e,this.authorization_token=t,void 0!==this.user_id&&""!==this.user_id&&this.user_id?void 0!==this.authorization_token&&""!==this.authorization_token&&this.authorization_token?(this.socket=this.socket("https://apis.troopmessenger.com",{query:"user_id="+this.user_id+"&token="+this.token+"&platform=1&checksum=_zxtyuIopQwRt&at="+this.authorization_token+"&uid="+this.uid}),this.socket.on("connect",function(){i.socket_id=this.io.engine.id}),this.socket.on("access_token",function(e){i.access_token=e.access_token,i.connection_state="connected",s.emit("connected")}),this.socket.on("disconnect",function(){i.connection_state="disconnected",s.emit("disconnected")}),this.socket.on("receive_message",function(e){s.emit("receive_message",e)}),this.socket.on("message_delivered",function(e){s.emit("message_delivered",e)}),this.socket.on("message_read",function(e){s.emit("message_read",e)}),this.socket.on("user_online",function(e){s.emit("user_online",e)}),this.socket.on("user_dnd",function(e){s.emit("user_dnd",e)}),this.socket.on("user_offline",function(e){s.emit("user_offline",e)}),this.socket.on("group_created",function(e){s.emit("group_created",e)}),this.socket.on("message_sent",function(e){s.emit("message_sent",e)}),this.socket.on("group_updated",function(e){s.emit("group_updated",e)}),this.socket.on("typing",function(e){s.emit("typing",e)}),this.socket.on("message_deleted",function(e){s.emit("message_deleted",e)}),this.socket.on("message_recalled",function(e){s.emit("message_recalled",e)}),this.socket.on("message_edited",function(e){s.emit("message_edited",e)}),s):(setTimeout(function(){s.emit("connect_error","Invalid authorization token")},0),s):(setTimeout(function(){s.emit("connect_error","Invalid user")},0),s)}sendTextMessage(e,t){let s=new Emitter;if("connected"!==this.connection_state)return setTimeout(function(){s.emit("tm_error","Connection to server is not yet established!")},0),s;if(void 0===e||!e||"object"!=typeof e)return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;if(void 0!==t&&t.is_forkout){if(!Array.isArray(e))return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;for(let t=0;t<e.length;t++)e[t].access_token=this.access_token,e[t].message_type=constants.MESSAGE_TYPE.TEXT;this.socket.emit("fork_out",e),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}else{if(void 0===e.receiver_id||!e.receiver_id)return setTimeout(function(){s.emit("tm_error","Invalid Receiver")},0),s;if(void 0===e.is_group)return setTimeout(function(){s.emit("tm_error","Value for 'is_group' not specified")},0),s;if("number"!=typeof e.is_group)return setTimeout(function(){s.emit("tm_error","Invalid value specified for 'is_group'")},0),s;if(""===e.message)return setTimeout(function(){s.emit("tm_error","Message cannot be empty")},0),s;void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),void 0===e.receiver_uid&&(e.receiver_uid=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,this.socket.emit("send_message",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,message:e.message,conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER}),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}return s}sendAttachment(e,t){let s=new Emitter;if("connected"!==this.connection_state)return setTimeout(function(){s.emit("tm_error","Connection to server is not yet established!")},0),s;if(void 0===e||!e||"object"!=typeof e)return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;if(void 0!==t&&t.is_forkout){if(!Array.isArray(e))return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;for(let t=0;t<e.length;t++)e[t].access_token=this.access_token,e[t].message_type=constants.MESSAGE_TYPE.ATTACHMENT;this.socket.emit("fork_out",e),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}else{if(void 0===e.receiver_id||!e.receiver_id)return setTimeout(function(){s.emit("tm_error","Invalid Receiver")},0),s;if(void 0===e.is_group)return setTimeout(function(){s.emit("tm_error","Value for 'is_group' not specified")},0),s;if("number"!=typeof e.is_group)return setTimeout(function(){s.emit("tm_error","Invalid value specified for 'is_group'")},0),s;if(""===e.attachment)return setTimeout(function(){s.emit("tm_error","Attachment cannot be empty")},0),s;void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,void 0===e.receiver_uid&&(e.receiver_uid=""),void 0===e.caption&&(e.caption=""),this.socket.emit("send_attachment",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,attachment:e.attachment,conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:e.caption}),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}return s}sendAudioMessage(e,t){let s=new Emitter;if("connected"!==this.connection_state)return setTimeout(function(){s.emit("tm_error","Connection to server is not yet established!")},0),s;if(void 0===e||!e||"object"!=typeof e)return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;if(void 0!==t&&t.is_forkout){if(!Array.isArray(e))return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;for(let t=0;t<e.length;t++)e[t].access_token=this.access_token,e[t].message_type=constants.MESSAGE_TYPE.AUDIO_MESSAGE;this.socket.emit("fork_out",e),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}else{if(void 0===e.receiver_id||!e.receiver_id)return setTimeout(function(){s.emit("tm_error","Invalid Receiver")},0),s;if(void 0===e.is_group)return setTimeout(function(){s.emit("tm_error","Value for 'is_group' not specified")},0),s;if("number"!=typeof e.is_group)return setTimeout(function(){s.emit("tm_error","Invalid value specified for 'is_group'")},0),s;if(""===e.attachment)return setTimeout(function(){s.emit("tm_error","Attachment cannot be empty")},0),s;void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,void 0===e.receiver_uid&&(e.receiver_uid=""),this.socket.emit("send_audio_message",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,attachment:e.attachment,conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER}),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}return s}messageDelivered(e){let t=new Emitter;return"connected"!==this.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&e.message_id?void 0===e.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof e.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):(e.access_token=this.access_token,this.socket.emit("message_delivered",{message_id:e.message_id,is_group:e.is_group,access_token:e.access_token}),this.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}messageRead(e){let t=new Emitter;return"connected"!==this.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&e.message_id?void 0===e.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof e.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):(e.access_token=this.access_token,this.socket.emit("message_read",{message_id:e.message_id,is_group:e.is_group,access_token:e.access_token}),this.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}sendContact(e,t){let s=new Emitter;if("connected"!==this.connection_state)return setTimeout(function(){s.emit("tm_error","Connection to server is not yet established!")},0),s;if(void 0===e||!e||"object"!=typeof e)return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;if(void 0!==t&&t.is_forkout){if(!Array.isArray(e))return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;for(let t=0;t<e.length;t++)e[t].access_token=this.access_token,e[t].message_type=constants.MESSAGE_TYPE.CONTACT;this.socket.emit("fork_out",e),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}else{if(void 0===e.receiver_id||!e.receiver_id)return setTimeout(function(){s.emit("tm_error","Invalid Receiver")},0),s;if(void 0===e.is_group)return setTimeout(function(){s.emit("tm_error","Value for 'is_group' not specified")},0),s;if("number"!=typeof e.is_group)return setTimeout(function(){s.emit("tm_error","Invalid value specified for 'is_group'")},0),s;if(""===e.contact_name||void 0===e.contact_name)return setTimeout(function(){s.emit("tm_error","Value for 'contact_name' is required")},0),s;if(""===e.contact_number||void 0===e.contact_number)return setTimeout(function(){s.emit("tm_error","Value for 'contact_number' is required")},0),s;void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,void 0===e.receiver_uid&&(e.receiver_uid=""),this.socket.emit("send_contact",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,contact_name:e.contact_name,contact_number:e.contact_number,conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER}),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}return s}sendLocation(e,t){let s=new Emitter;if("connected"!==this.connection_state)return setTimeout(function(){s.emit("tm_error","Connection to server is not yet established!")},0),s;if(void 0===e||!e||"object"!=typeof e)return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;if(void 0!==t&&t.is_forkout){if(!Array.isArray(e))return setTimeout(function(){s.emit("tm_error","Invalid Data")},0),s;for(let t=0;t<e.length;t++)e[t].access_token=this.access_token,e[t].message_type=constants.MESSAGE_TYPE.LOCATION;this.socket.emit("fork_out",e),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}else{if(void 0===e.receiver_id||!e.receiver_id)return setTimeout(function(){s.emit("tm_error","Invalid Receiver")},0),s;if(void 0===e.is_group)return setTimeout(function(){s.emit("tm_error","Value for 'is_group' not specified")},0),s;if("number"!=typeof e.is_group)return setTimeout(function(){s.emit("tm_error","Invalid value specified for 'is_group'")},0),s;if(""===e.location_latitude||void 0===e.location_latitude)return setTimeout(function(){s.emit("tm_error","Value for 'location_latitude' is required")},0),s;if(""===e.location_longitude||void 0===e.location_longitude)return setTimeout(function(){s.emit("tm_error","Value for 'location_longitude' is required")},0),s;if(""===e.location_address||void 0===e.location_address)return setTimeout(function(){s.emit("tm_error","Value for 'location_address' is required")},0),s;if(""===e.location_name||void 0===e.location_name)return setTimeout(function(){s.emit("tm_error","Value for 'location_name' is required")},0),s;void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,void 0===e.receiver_uid&&(e.receiver_uid=""),this.socket.emit("send_location",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,location_latitude:e.location_latitude,location_longitude:e.location_longitude,location_address:e.location_address,location_name:e.location_name,conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER}),this.socket.once("tm_error",function(e){s.emit("tm_error",e)})}return s}getOnlineUsers(){let e=new Emitter;return this.socket.emit("get_user_availability_status",{access_token:this.access_token}),this.socket.once("user_availability_status",function(t){e.emit("online_users",t)}),this.socket.once("tm_error",function(t){e.emit("tm_error",t)}),e}updateStatus(e){let t=new Emitter;return void 0!==e&&e?(e=parseInt(e),-1===constants.USER_AVAILABILITY_STATUS.indexOf(e)?(t.emit("tm_error",{message:"Invalid status"}),t):(this.socket.emit("change_user_availability_status",{access_token:this.access_token,status:e}),this.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t)):(t.emit("tm_error",{message:"Invalid status"}),t)}setTyping(e){let t=new Emitter;return void 0!==e&&e&&"object"==typeof e?void 0!==e.receiver_id&&e.receiver_id?(void 0===e.is_group&&(e.is_group=0),void 0===e.typing&&(e.typing=0),void 0===e.typing_user_name&&(e.typing_user_name=""),e.access_token=this.access_token,this.socket.emit("typing",{receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,typing:e.typing,typing_user_name:e.typing_user_name}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}getMessageTime(e){return getDate(e)}getMessageDeliveryStatusText(e,t){let s;return s=1===e?constants.MESSAGE_DELIVERY_STATUS_READ_TEXT:1===t?constants.MESSAGE_DELIVERY_STATUS_DELIVERED_TEXT:2===t?constants.MESSAGE_DELIVERY_STATUS_PENDING_TEXT:constants.MESSAGE_DELIVERY_STATUS_SENT_TEXT}messageType(){return{TEXT:constants.MESSAGE_TYPE.TEXT,ATTACHMENT:constants.MESSAGE_TYPE.ATTACHMENT,CONTACT:constants.MESSAGE_TYPE.CONTACT,LOCATION:constants.MESSAGE_TYPE.LOCATION,GROUP_CREATED:constants.MESSAGE_TYPE.GROUP_CREATED,GROUP_NAME_UPDATED:constants.MESSAGE_TYPE.GROUP_NAME_UPDATED,GROUP_AVATAR_UPDATED:constants.MESSAGE_TYPE.GROUP_AVATAR_UPDATED,GROUP_STATUS_UPDATED:constants.MESSAGE_TYPE.GROUP_STATUS_UPDATED,GROUP_MEMBER_EXITED:constants.MESSAGE_TYPE.GROUP_MEMBER_EXITED,GROUP_MEMBER_ADDED:constants.MESSAGE_TYPE.GROUP_MEMBER_ADDED,GROUP_MEMBER_DELETED:constants.MESSAGE_TYPE.GROUP_MEMBER_DELETED,GROUP_MEMBER_ROLE_UPDATED:constants.MESSAGE_TYPE.GROUP_MEMBER_ROLE_UPDATED,VIDEO_CALL_ACCEPTED:constants.MESSAGE_TYPE.VIDEO_CALL_ACCEPTED,VIDEO_CALL_REJECTED:constants.MESSAGE_TYPE.VIDEO_CALL_REJECTED,VIDEO_CALL_MISSED:constants.MESSAGE_TYPE.VIDEO_CALL_MISSED,VIDEO_CALL_ABORTED:constants.MESSAGE_TYPE.VIDEO_CALL_ABORTED,DESKTOP_SHARING_ACCEPTED:constants.MESSAGE_TYPE.DESKTOP_SHARING_ACCEPTED,DESKTOP_SHARING_REJECTED:constants.MESSAGE_TYPE.DESKTOP_SHARING_REJECTED,DESKTOP_SHARING_MISSED:constants.MESSAGE_TYPE.DESKTOP_SHARING_MISSED,AUDIO_CALL_ACCEPTED:constants.MESSAGE_TYPE.AUDIO_CALL_ACCEPTED,AUDIO_CALL_REJECTED:constants.MESSAGE_TYPE.AUDIO_CALL_REJECTED,AUDIO_CALL_MISSED:constants.MESSAGE_TYPE.AUDIO_CALL_MISSED,AUDIO_CALL_ABORTED:constants.MESSAGE_TYPE.AUDIO_CALL_ABORTED,AUDIO_MESSAGE:constants.MESSAGE_TYPE.AUDIO_MESSAGE,META_LINK:constants.MESSAGE_TYPE.META_LINK}}entity(){return{USER:constants.ENTITY.USER,GROUP:constants.ENTITY.GROUP}}groupMemberRole(){return{ADMIN:constants.GROUP_ROLE_ADMIN,NORMAL:constants.GROUP_ROLE_NORMAL,MODERATOR:constants.GROUP_ROLE_MODERATOR}}parseMessage(e){try{return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}catch(t){return e}}sendAudioMessageReply(e){let t=new Emitter;return"connected"!==this.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&e.message_id?void 0!==e.receiver_id&&e.receiver_id?void 0===e.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof e.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===e.attachment?(setTimeout(function(){t.emit("tm_error","Attachment cannot be empty")},0),t):(void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),void 0===e.receiver_uid&&(e.receiver_uid=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,this.socket.emit("reply_message",{message_id:e.message_id,message_type:constants.MESSAGE_TYPE.AUDIO_MESSAGE,receiver_id:e.receiver_id,is_group:e.is_group,access_token:e.access_token,message:"",conversation_reference_id:e.conversation_reference_id,receiver_uid:e.receiver_uid,entity:1===e.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:"",attachment:e.attachment,status:1}),this.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}reply(){let e=this,t=new Emitter;return{text:function(s){return"connected"!==e.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==s&&s&&"object"==typeof s?void 0!==s.message_id&&s.message_id?void 0!==s.receiver_id&&s.receiver_id?void 0===s.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof s.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===s.message?(setTimeout(function(){t.emit("tm_error","Message cannot be empty")},0),t):(void 0===s.conversation_reference_id&&(s.conversation_reference_id=""),void 0===s.receiver_uid&&(s.receiver_uid=""),s.is_group=parseInt(s.is_group),s.access_token=e.access_token,e.socket.emit("reply_message",{message_id:s.message_id,message_type:constants.MESSAGE_TYPE.TEXT,receiver_id:s.receiver_id,is_group:s.is_group,access_token:s.access_token,message:s.message,conversation_reference_id:s.conversation_reference_id,receiver_uid:s.receiver_uid,entity:1===s.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:"",attachment:"",status:1}),e.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)},attachment:function(s){return"connected"!==e.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==s&&s&&"object"==typeof s?void 0!==s.message_id&&s.message_id?void 0!==s.receiver_id&&s.receiver_id?void 0===s.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof s.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===s.attachment?(setTimeout(function(){t.emit("tm_error","Attachment cannot be empty")},0),t):(void 0===s.caption&&(s.caption=""),void 0===s.conversation_reference_id&&(s.conversation_reference_id=""),void 0===s.receiver_uid&&(s.receiver_uid=""),s.is_group=parseInt(s.is_group),s.access_token=e.access_token,e.socket.emit("reply_message",{message_id:s.message_id,message_type:constants.MESSAGE_TYPE.ATTACHMENT,receiver_id:s.receiver_id,is_group:s.is_group,access_token:s.access_token,message:"",conversation_reference_id:s.conversation_reference_id,receiver_uid:s.receiver_uid,entity:1===s.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:s.caption,attachment:s.attachment,status:1}),e.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)},contact:function(s){return"connected"!==e.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==s&&s&&"object"==typeof s?void 0!==s.message_id&&s.message_id?void 0!==s.receiver_id&&s.receiver_id?void 0===s.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof s.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===s.contact_name||void 0===s.contact_name?(setTimeout(function(){t.emit("tm_error","Value for 'contact_name' is required")},0),t):""===s.contact_number||void 0===s.contact_number?(setTimeout(function(){t.emit("tm_error","Value for 'contact_number' is required")},0),t):(void 0===s.conversation_reference_id&&(s.conversation_reference_id=""),void 0===s.receiver_uid&&(s.receiver_uid=""),s.is_group=parseInt(s.is_group),s.access_token=e.access_token,e.socket.emit("reply_message",{message_id:s.message_id,message_type:constants.MESSAGE_TYPE.CONTACT,receiver_id:s.receiver_id,is_group:s.is_group,access_token:s.access_token,message:"",conversation_reference_id:s.conversation_reference_id,receiver_uid:s.receiver_uid,entity:1===s.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:"",attachment:"",status:1,contact_name:s.contact_name,contact_number:s.contact_number}),e.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)},location:function(s){return"connected"!==e.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==s&&s&&"object"==typeof s?void 0!==s.message_id&&s.message_id?void 0!==s.receiver_id&&s.receiver_id?void 0===s.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof s.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===s.location_latitude||void 0===s.location_latitude?(setTimeout(function(){t.emit("tm_error","Value for 'location_latitude' is required")},0),t):""===s.location_longitude||void 0===s.location_longitude?(setTimeout(function(){t.emit("tm_error","Value for 'location_longitude' is required")},0),t):""===s.location_address||void 0===s.location_address?(setTimeout(function(){t.emit("tm_error","Value for 'location_address' is required")},0),t):""===s.location_name||void 0===s.location_name?(setTimeout(function(){t.emit("tm_error","Value for 'location_name' is required")},0),t):(void 0===s.conversation_reference_id&&(s.conversation_reference_id=""),void 0===s.receiver_uid&&(s.receiver_uid=""),s.is_group=parseInt(s.is_group),s.access_token=e.access_token,e.socket.emit("reply_message",{message_id:s.message_id,message_type:constants.MESSAGE_TYPE.LOCATION,receiver_id:s.receiver_id,is_group:s.is_group,access_token:s.access_token,message:"",conversation_reference_id:s.conversation_reference_id,receiver_uid:s.receiver_uid,entity:1===s.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:"",attachment:"",status:1,location_latitude:s.location_latitude,location_longitude:s.location_longitude,location_address:s.location_address,location_name:s.location_name}),e.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)},audioMessage:function(s){return"connected"!==e.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==s&&s&&"object"==typeof s?void 0!==s.message_id&&s.message_id?void 0!==s.receiver_id&&s.receiver_id?void 0===s.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof s.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===s.attachment?(setTimeout(function(){t.emit("tm_error","Attachment cannot be empty")},0),t):(void 0===s.conversation_reference_id&&(s.conversation_reference_id=""),void 0===s.receiver_uid&&(s.receiver_uid=""),s.is_group=parseInt(s.is_group),s.access_token=e.access_token,e.socket.emit("reply_message",{message_id:s.message_id,message_type:constants.MESSAGE_TYPE.AUDIO_MESSAGE,receiver_id:s.receiver_id,is_group:s.is_group,access_token:s.access_token,message:"",conversation_reference_id:s.conversation_reference_id,receiver_uid:s.receiver_uid,entity:1===s.is_group?constants.ENTITY_GROUP:constants.ENTITY_USER,caption:"",attachment:s.attachment,status:1}),e.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}}}forwardMessage(e){let t=new Emitter;return"connected"!==this.connection_state?(setTimeout(function(){t.emit("tm_error","Connection to server is not yet established!")},0),t):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&Array.isArray(e.message_id)?void 0!==e.forward_to&&Array.isArray(e.forward_to)?void 0===e.is_group?(setTimeout(function(){t.emit("tm_error","Value for 'is_group' not specified")},0),t):"number"!=typeof e.is_group?(setTimeout(function(){t.emit("tm_error","Invalid value specified for 'is_group'")},0),t):""===e.message?(setTimeout(function(){t.emit("tm_error","Message cannot be empty")},0),t):(void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),e.is_group=parseInt(e.is_group),e.access_token=this.access_token,this.socket.emit("forward_message",{forward_to:e.forward_to,is_group:e.is_group,access_token:e.access_token,message_id:e.message_id,conversation_reference_id:e.conversation_reference_id,status:1,reference_id:[],is_forward:1}),this.socket.once("tm_error",function(e){t.emit("tm_error",e)}),t):(setTimeout(function(){t.emit("tm_error","Invalid Receiver")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Message(s)")},0),t):(setTimeout(function(){t.emit("tm_error","Invalid Data")},0),t)}deleteMessage(e,t){return void 0!==t&&"function"==typeof t&&("connected"!==this.connection_state?t({status:!1,message:"Connection to server is not yet established!"}):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&Array.isArray(e.message_id)?void 0===e.entity_type?t({status:!1,message:"Value for 'entity_type' is not specified"}):void 0===e.entity_id?t({status:!1,message:"Value for 'entity_id' is not specified"}):(e.access_token=this.access_token,void this.socket.emit("delete_message",{message_id:e.message_id,entity_type:e.entity_type,entity_id:e.entity_id,access_token:e.access_token},function(e){return t(e)})):t({status:!1,message:"Invalid Message(s)"}):t({status:!1,message:"Invalid Data"}))}recallMessage(e,t){return void 0!==t&&"function"==typeof t&&("connected"!==this.connection_state?t({status:!1,message:"Connection to server is not yet established!"}):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&Array.isArray(e.message_id)?void 0===e.entity_type?t({status:!1,message:"Value for 'entity_type' is not specified"}):void 0===e.entity_id?t({status:!1,message:"Value for 'entity_id' is not specified"}):(e.access_token=this.access_token,void this.socket.emit("recall_message",{message_id:e.message_id,entity_type:e.entity_type,entity_id:e.entity_id,access_token:e.access_token},function(e){return t(e)})):t({status:!1,message:"Invalid Message(s)"}):t({status:!1,message:"Invalid Data"}))}editMessage(e,t){return void 0!==t&&"function"==typeof t&&("connected"!==this.connection_state?t({status:!1,message:"Connection to server is not yet established!"}):void 0!==e&&e&&"object"==typeof e?void 0!==e.message_id&&e.message_id?void 0===e.message?t({status:!1,message:"Message cannot be empty"}):void 0===e.is_group?t({status:!1,message:"Value for 'is_group' not specified"}):"number"!=typeof e.is_group?t({status:!1,message:"Invalid value specified for 'is_group'"}):(e.access_token=this.access_token,void this.socket.emit("edit_message",{message_id:e.message_id,message:e.message,is_group:e.is_group,access_token:e.access_token},function(e){return t(e)})):t({status:!1,message:"Invalid Message"}):t({status:!1,message:"Invalid Data"}))}async getConversation(e){return void 0!==e&&e&&"object"==typeof e?(void 0===e.last_message_id&&(e.last_message_id=0),void 0===e.is_group?{success:!1,message:"Value for 'is_group' not specified"}:"number"!=typeof e.is_group?{success:!1,message:"Invalid value specified for 'is_group'"}:void 0===e.entity_id?{success:!1,message:"Value for 'is_group' not specified"}:e.entity_id?(void 0===e.conversation_reference_id&&(e.conversation_reference_id=""),await axios.post("/api/messenger/get-conversation",{socket_id:this.socket_id,user_id:this.user_id,access_token:this.access_token,token:this.token,last_message_id:e.last_message_id,is_group:e.is_group,entity_id:e.entity_id,conversation_reference_id:e.conversation_reference_id,limit:50,sort:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})):{success:!1,message:"Invalid value specified for 'is_group'"}):{success:!1,message:"Invalid data"}}async getMessages(e){let t="";return void 0!==e&&void 0!==e.conversation_reference_id&&(t=e.conversation_reference_id),await axios.post("/api/messenger/get-messages",{socket_id:this.socket_id,user_id:this.user_id,access_token:this.access_token,token:this.token,conversation_reference_id:t}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})}async getChatList(e){let t="";return void 0!==e&&void 0!==e.conversation_reference_id&&(t=e.conversation_reference_id),await axios.post("/api/messenger/get-chat-list",{socket_id:this.socket_id,user_id:this.user_id,access_token:this.access_token,token:this.token,conversation_reference_id:t}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})}async updateGroupMemberStatus(e){return void 0!==e&&e&&"object"==typeof e?void 0!==e.group_id&&e.group_id&&""!==e.group_id?void 0!==e.member_role&&e.member_role&&-1!==constants.VALID_GROUP_MEMBER_ROLE.indexOf(e.member_role)?void 0!==e.member_id&&e.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_USER_ROLE,group_id:e.group_id,member_id:e.member_id,user_role:e.member_role,socket_id:this.socket_id,user_id:this.user_id,access_token:this.access_token,token:this.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid member role"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}}group(){let e=this;return{create:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0===t.group_name||""===t.group_name?{success:!1,message:"Group name is required"}:(void 0===t.group_description&&(t.group_description=""),void 0===t.group_avatar&&(t.group_avatar=""),void 0===t.members||""===t.members?{success:!1,message:"Group members are required"}:Array.isArray(t.members)?t.members.length?await axios.post("/api/messenger/create-group",{socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,group_name:t.group_name,group_description:t.group_description,group_avatar:t.group_avatar,group_members:JSON.stringify(t.members),platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Group members are required"}:{success:!1,message:"Invalid data passed for 'members'"}):{success:!1,message:"Invalid data"}},updateName:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.group_name&&t.group_name&&""!==t.group_name?(t.group_name=t.group_name.toString(),t.group_name.length<1?{success:!1,message:"Group Name cannot be empty"}:t.group_name.length>constants.MAX_GROUP_NAME_CHARACTERS?{success:!1,message:"Maximum "+constants.MAX_GROUP_NAME_CHARACTERS+" characters are allowed for Group Name"}:await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_NAME,group_id:t.group_id,group_name:t.group_name,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})):{success:!1,message:"Invalid Group Name"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},updateAvatar:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?(void 0!==t.group_avatar&&t.group_avatar||(t.group_avatar=""),await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_AVATAR,group_id:t.group_id,group_avatar:t.group_avatar,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})):{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},makeAdmin:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.member_id&&t.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_USER_ROLE,group_id:t.group_id,member_id:t.member_id,user_role:constants.GROUP_ROLE_ADMIN,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},makeModerator:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.member_id&&t.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_USER_ROLE,group_id:t.group_id,member_id:t.member_id,user_role:constants.GROUP_ROLE_MODERATOR,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},removeAdmin:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.member_id&&t.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_USER_ROLE,group_id:t.group_id,member_id:t.member_id,user_role:constants.GROUP_ROLE_NORMAL,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},removeModerator:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.member_id&&t.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_USER_ROLE,group_id:t.group_id,member_id:t.member_id,user_role:constants.GROUP_ROLE_NORMAL,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},removeUser:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?void 0!==t.member_id&&t.member_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_DELETE_GROUP_MEMBERS,group_id:t.group_id,group_members:t.member_id+"",socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid member"}:{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},delete:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_UPDATE_GROUP_STATUS,group_id:t.group_id,delete_group:1,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},exit:async function(t){return void 0!==t&&t&&"object"==typeof t?void 0!==t.group_id&&t.group_id&&""!==t.group_id?await axios.post("/api/messenger/update-group",{payload:constants.PAYLOAD_EXIT_GROUP,group_id:t.group_id,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid Group"}:{success:!1,message:"Invalid data"}},addMembers:async function(t){return void 0===t||"object"!=typeof t?{success:!1,message:"Invalid data"}:void 0!==t.group_id&&t.group_id?void 0!==t.members&&Array.isArray(t.members)&&t.members.length?await axios.post("/api/messenger/add-group-members",{group_id:t.group_id,group_members:JSON.stringify(t.members),socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Member(s) are required"}:{success:!1,message:"Invalid Group"}},details:async function(t){return void 0===t||"object"!=typeof t?{success:!1,message:"Invalid data"}:void 0!==t.group_id&&t.group_id?await axios.post("/api/messenger/get-group-details",{group_id:t.group_id,socket_id:e.socket_id,user_id:e.user_id,access_token:e.access_token,token:e.token,platform:1}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}}):{success:!1,message:"Invalid Group"}}}}}function getDate(e,t){var s=moment(e).toDate(),i=(s=getTimeZoneDate(s)).toLocaleString("en-US",{month:"long"}),o=prependZero(s.getDate().toString()),r=prependZero(s.getHours().toString())+":"+prependZero(s.getMinutes().toString());return t?i+" "+o+"  "+r:r}function getTimeZoneDate(e){return localize(convertDateToUTC(e))}function localize(e){var t=moment.utc(moment(e).format("YYYY-MM-DD HH:mm:ss")).toDate();return t=moment(moment(t).format("YYYY-MM-DD HH:mm:ss")).toDate()}function convertDateToUTC(e){var t=moment(e).toDate();return moment(t.getTime()+-198e5).toDate()}function prependZero(e){return e.length<2?"0"+e:e}async function register(e,t,s,i=0){return void 0===e||""===e?{success:!1,message:"uid is required"}:void 0===t||""===t?{success:!1,message:"name is required"}:await axios.post("/api/messenger/v2/register",{token:s,uid:e,name:t,behalf:i}).then(async function(e){return e.data}).catch(function(e){return{success:!1,message:e.message}})}module.exports=TroopMessenger,global.TroopMessenger=TroopMessenger;